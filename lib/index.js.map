{"version":3,"sources":["../src/index.js"],"names":["server","ApolloServer","typeDefs","resolvers","context","req","connection","db","prisma","subscriptions","onConnect","connectionParams","authToken","APP_SECRET","userId","Error","user","uid","onDisconnect","webSocket","console","log","validationRules","app","applyMiddleware","use","bodyParser","json","urlencoded","extended","post","res","obj","body","sign","sign_type","verRes","trade","id","out_trade_no","amount","parseFloat","total_amount","app_id","seller_id","send","updateTrade","where","data","status","listen","port","PORT","HOST","graphqlPath"],"mappings":"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","sourcesContent":["import 'babel-polyfill';\r\nimport express from 'express'\r\nimport bodyParser from 'body-parser'\r\nimport { ApolloServer } from 'apollo-server-express'\r\nimport {verify} from 'jsonwebtoken'\r\nimport depthLimit from 'graphql-depth-limit'\r\n\r\nimport { APP_SECRET,verified } from './services/utils'\r\nimport  {raw} from './services/helper'\r\nimport { prisma } from './generated/prisma-client'\r\nimport { resolvers } from './resolvers'\r\nimport { typeDefs } from './schema'\r\nimport {HOST,PORT} from './services/settings'\r\n\r\n\r\nconst server = new ApolloServer({\r\n  typeDefs,\r\n  resolvers,\r\n  context: async ({req,connection}) => {\r\n    if (connection) {\r\n      // check connection for metadata\r\n      return connection.context;\r\n    }\r\n\r\n    return {\r\n      req,\r\n      db: prisma,\r\n    }\r\n  },\r\n  subscriptions: {\r\n    onConnect: async (connectionParams) => {\r\n      if (connectionParams.authToken) {\r\n        const {userId} = verify(connectionParams.authToken, APP_SECRET)\r\n        if (!userId) {\r\n          throw new Error(\"tokené”™è¯¯\")\r\n        }\r\n        const user = await prisma.user({ uid: userId })\r\n        if(user){\r\n          return {user,db:prisma}\r\n          \r\n        }\r\n        throw new Error(\"ç”¨æˆ·ä¸å­˜åœ¨\")\r\n      }\r\n      throw new Error('Missing auth token!');\r\n    },\r\n    onDisconnect: (webSocket, context) => {\r\n      console.log('ç»“æŸè®¢é˜…')\r\n    },\r\n  },\r\n  validationRules: [ depthLimit(10) ],// æœ€å¤§æ·±åº¦æŸ¥è¯¢é™åˆ¶ã€‚\r\n});\r\n\r\nconst app = express();\r\nserver.applyMiddleware({ app });\r\n\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.urlencoded({ extended: false }));\r\n\r\napp.post('/alipay/notify_url',  async (req, res)=> {\r\n  const obj = req.body\r\n  const sign = req.body.sign\r\n  delete obj.sign\r\n  delete obj.sign_type\r\n\r\n  const verRes = verified(raw(obj), sign)\r\n  if (verRes) {\r\n      \r\n      /** \r\n       * 1ã€å•†æˆ·éœ€è¦éªŒè¯è¯¥é€šçŸ¥æ•°æ®ä¸­çš„out_trade_noæ˜¯å¦ä¸ºå•†æˆ·ç³»ç»Ÿä¸­åˆ›å»ºçš„è®¢å•å·ï¼Œ\r\n       * 2ã€åˆ¤æ–­total_amountæ˜¯å¦ç¡®å®žä¸ºè¯¥è®¢å•çš„å®žé™…é‡‘é¢ï¼ˆå³å•†æˆ·è®¢å•åˆ›å»ºæ—¶çš„é‡‘é¢ï¼‰\r\n       * 3ã€æ ¡éªŒé€šçŸ¥ä¸­çš„seller_idï¼ˆæˆ–è€…seller_email) æ˜¯å¦ä¸ºout_trade_noè¿™ç¬”å•æ®çš„å¯¹åº”çš„æ“ä½œæ–¹ï¼ˆæœ‰çš„æ—¶å€™ï¼Œä¸€ä¸ªå•†æˆ·å¯èƒ½æœ‰å¤šä¸ªseller_id/seller_emailï¼‰\r\n       * 4ã€éªŒè¯app_idæ˜¯å¦ä¸ºè¯¥å•†æˆ·æœ¬èº«ã€‚ä¸Šè¿°1ã€2ã€3ã€4æœ‰ä»»ä½•ä¸€ä¸ªéªŒè¯ä¸é€šè¿‡ï¼Œåˆ™è¡¨æ˜Žæœ¬æ¬¡é€šçŸ¥æ˜¯å¼‚å¸¸é€šçŸ¥ï¼ŒåŠ¡å¿…å¿½ç•¥ã€‚åœ¨ä¸Šè¿°éªŒè¯é€šè¿‡åŽå•†æˆ·å¿…é¡»æ ¹æ®æ”¯ä»˜å®ä¸åŒç±»åž‹çš„ä¸šåŠ¡é€šçŸ¥ï¼Œ\r\n       * æ­£ç¡®çš„è¿›è¡Œä¸åŒçš„ä¸šåŠ¡å¤„ç†ï¼Œå¹¶ä¸”è¿‡æ»¤é‡å¤çš„é€šçŸ¥ç»“æžœæ•°æ®ã€‚\r\n       * åœ¨æ”¯ä»˜å®çš„ä¸šåŠ¡é€šçŸ¥ä¸­ï¼Œåªæœ‰äº¤æ˜“é€šçŸ¥çŠ¶æ€ä¸ºTRADE_SUCCESSæˆ–TRADE_FINISHEDæ—¶ï¼Œæ”¯ä»˜å®æ‰ä¼šè®¤å®šä¸ºä¹°å®¶ä»˜æ¬¾æˆåŠŸã€‚\r\n      */\r\n      // æŒ‰ç…§æ”¯ä»˜ç»“æžœå¼‚æ­¥é€šçŸ¥ä¸­çš„æè¿°ï¼Œå¯¹æ”¯ä»˜ç»“æžœä¸­çš„ä¸šåŠ¡å†…å®¹è¿›è¡Œ1\\2\\3\\4äºŒæ¬¡æ ¡éªŒï¼Œæ ¡éªŒæˆåŠŸåŽåœ¨responseä¸­è¿”å›žsuccessï¼Œæ ¡éªŒå¤±è´¥è¿”å›žfailure\r\n      const trade = await prisma.trade({id:obj.out_trade_no})\r\n      if(trade){\r\n        const amount = await prisma.trade({id:obj.out_trade_no}).amount()\r\n        if(parseFloat(obj.total_amount)!==amount ||\r\n        obj.app_id !== \"2019022063305057\" ||\r\n        obj.seller_id !==\"2088431374041067\"  // è´¦æˆ·PID\r\n        ){\r\n          res.send('failure') \r\n        }else{\r\n          await prisma.updateTrade({\r\n            where:{id:obj.out_trade_no},\r\n            data:{status:\"1\"}\r\n          })\r\n          res.send('success')\r\n        }\r\n      }\r\n  } else {\r\n      res.send('failure')\r\n  }\r\n})\r\n\r\n// server.listen({ port: PORT ,host:\"192.168.43.75\"   }).then(({ url }) => console.log(`ðŸš€ Server ready at ${url}`));\r\napp.listen({ port: PORT }, () =>\r\n  console.log(`ðŸš€ Server ready at http://${HOST}:${PORT}${server.graphqlPath}`)\r\n);\r\n// ,host:\"192.168.0.102\" \r\n\r\n"],"file":"index.js"}