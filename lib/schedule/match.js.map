{"version":3,"sources":["../../src/schedule/match.js"],"names":["now","phase","parseInt","getTime","DateStartTime","match","prisma","cities","lovecity","loveSignUps","where","AND","city","code","period","cityLoveSignUps","signUpPersons","citLoveSignUp","loveSignUp","id","person","loveSetting","grade","memeberGrade","memeberGradeEndTime","Date","updateLoveSetting","data","newPerson","gender","age","birthday","myHeight","myWeight","otherAgeMin","otherAgeMax","otherHeightMin","otherHeightMax","otherWeightMin","otherWeightMax","push","sortedSignUpPersons","sort","a","b","matchedPersons","matcher","womanId","manId","indexOf","loveMatchings","woman","man","pastLoveMatchings","length","createLoveMatching","connect","personId","console","log"],"mappings":"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","sourcesContent":["/**\r\n * 每周四晚上12点执行。\r\n *思路：\r\n * 1、首先从数据库挑选出第一个城市里的所有用户\r\n * 2、对该城市的所有用户按照会员级别进行排序，得到一个用户列表\r\n * 3、从第一个用户开始计算匹配，匹配到计入数据库，并从列表中删除。\r\n * 4、该城市用户列表长度为0时停止\r\n * 5、将第一个用户所在城市从数据库中删除。挑选第二个用户所在城市，按照第一个城市算法计算。\r\n * 6、数据库长度为0时停止计算。\r\n * */\r\nimport 'babel-polyfill';\r\nimport { prisma } from '../generated/prisma-client'\r\nimport { DateStartTime } from '../services/settings'\r\nimport { birthdayToAge,getTimeByTimeZone } from '../services/utils'\r\n\r\nconst now = getTimeByTimeZone(8)\r\nconst phase = parseInt(`${(now.getTime() - DateStartTime.getTime()) / 1000 / 60 / 60 / 24 / 7}`, 10) + 1\r\nconst match = async () => {\r\n    const cities = await prisma.cities()\r\n    for (const lovecity of cities) {\r\n        // 1、找到该城市所有当期报名的人。\r\n        const cityLoveSignUps = await prisma.loveSignUps({\r\n            where: {\r\n                AND: [\r\n                    { city: { code: lovecity.code } },\r\n                    { period: `${phase}` }\r\n                ]\r\n            }\r\n        })\r\n        // 2、对该城市的所有用户按照会员级别进行排序，得到一个用户列表\r\n        const signUpPersons = []\r\n        for (const citLoveSignUp of cityLoveSignUps) {\r\n            const person = await prisma.loveSignUp({ id: citLoveSignUp.id }).person()\r\n            const loveSetting = await prisma.loveSignUp({ id: citLoveSignUp.id }).person().loveSetting()\r\n            // 计算会员等级\r\n            let grade = loveSetting.memeberGrade\r\n            // 如果会员等级为null，则grade为0\r\n            if (!loveSetting.memeberGrade) {\r\n                grade = 0\r\n            }\r\n            // 如果会员过期了，则grade为0\r\n            if (loveSetting.memeberGradeEndTime) {\r\n                if (new Date(loveSetting.memeberGradeEndTime) < new Date()) {\r\n                    await prisma.updateLoveSetting({\r\n                        where: { id: loveSetting.id },\r\n                        data: {\r\n                            memeberGrade: 0,\r\n                            memeberGradeEndTime: null,\r\n                        }\r\n                    })\r\n                    grade = 0\r\n                }\r\n            }\r\n\r\n            const newPerson = {\r\n                id: person.id,\r\n                gender: person.gender,\r\n                age: birthdayToAge(person.birthday),\r\n                myHeight: loveSetting.myHeight,\r\n                myWeight: loveSetting.myWeight,\r\n                otherAgeMin: loveSetting.otherAgeMin,\r\n                otherAgeMax: loveSetting.otherAgeMax,\r\n                otherHeightMin: loveSetting.otherHeightMin,\r\n                otherHeightMax: loveSetting.otherHeightMax,\r\n                otherWeightMin: loveSetting.otherWeightMin,\r\n                otherWeightMax: loveSetting.otherWeightMax,\r\n                memeberGrade: grade\r\n            }\r\n            signUpPersons.push(newPerson)\r\n        }\r\n        // 报名者按照等级从高到低排序\r\n        const sortedSignUpPersons = signUpPersons.sort((a, b) => b.memeberGrade - a.memeberGrade)\r\n        // 3、从第一个用户开始计算匹配，匹配到计入数据库。\r\n        const matchedPersons = []\r\n        for (const person of sortedSignUpPersons) {\r\n            for (const matcher of sortedSignUpPersons) {\r\n                let womanId\r\n                let manId\r\n                if (person.gender === \"male\") {\r\n                    manId = person.id\r\n                    womanId = matcher.id\r\n                } else {\r\n                    manId = matcher.id\r\n                    womanId = person.id\r\n                }\r\n                // 如果匹配成功\r\n                if (\r\n                    !~matchedPersons.indexOf(person.id) &&\r\n                    !~matchedPersons.indexOf(matcher.id) &&\r\n                    person.gender !== matcher.gender &&\r\n                    person.age >= matcher.otherAgeMin &&\r\n                    person.age <= matcher.otherAgeMax &&\r\n                    person.myHeight <= matcher.otherHeightMax &&\r\n                    person.myHeight >= matcher.otherHeightMin &&\r\n                    person.myWeight <= matcher.otherWeightMax &&\r\n                    person.myWeight >= matcher.otherWeightMin &&\r\n                    matcher.age >= person.otherAgeMin &&\r\n                    matcher.age <= person.otherAgeMax &&\r\n                    matcher.myHeight >= person.otherHeightMin &&\r\n                    matcher.myHeight <= person.otherHeightMax &&\r\n                    matcher.myWeight >= person.otherWeightMin &&\r\n                    matcher.myWeight <= person.otherWeightMax\r\n                ) {\r\n                    // 检查以前是否匹配成功过，匹配成功过的不再重复匹配\r\n                    const pastLoveMatchings = await prisma.loveMatchings({\r\n                        where:{\r\n                            AND:[\r\n                                {woman: {  id: womanId } },\r\n                                {man:  { id: manId } }\r\n                            ]\r\n                        }\r\n                    })\r\n                    if(pastLoveMatchings.length===0){\r\n                        matchedPersons.push(person.id)\r\n                        matchedPersons.push(matcher.id)\r\n                        await prisma.createLoveMatching({\r\n                            period: `${phase}`,\r\n                            city: { connect: { code: lovecity.code } },\r\n                            woman: { connect: { id: womanId } },\r\n                            man: { connect: { id: manId } }\r\n                        })\r\n                        break\r\n                    }\r\n                }\r\n            }\r\n            // 没有匹配成功,对象为null\r\n            const personId = person.id\r\n            if (!~matchedPersons.indexOf(person.id)) {\r\n                matchedPersons.push(personId)\r\n                if (person.gender === \"male\") {\r\n                    await prisma.createLoveMatching({\r\n                        period: `${phase}`,\r\n                        city: { connect: { code: lovecity.code } },\r\n                        man: { connect: { id: personId } }\r\n                    })\r\n                } else {\r\n                    await prisma.createLoveMatching({\r\n                        period: `${phase}`,\r\n                        city: { connect: { code: lovecity.code } },\r\n                        woman: { connect: { id: personId } },\r\n                    })\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n\r\nconsole.log('match start...')\r\nmatch()\r\nconsole.log('match over!')\r\n\r\n"],"file":"match.js"}