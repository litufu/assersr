{"version":3,"sources":["../../src/schedule/match.js"],"names":["now","Date","phase","parseInt","getTime","DateStartTime","match","prisma","cities","lovecity","loveSignUps","where","AND","city","code","period","cityLoveSignUps","signUpPersons","citLoveSignUp","loveSignUp","id","person","loveSetting","grade","memeberGrade","memeberGradeEndTime","updateLoveSetting","data","newPerson","gender","age","birthday","myHeight","myWeight","otherAgeMin","otherAgeMax","otherHeightMin","otherHeightMax","otherWeightMin","otherWeightMax","push","sortedSignUpPersons","sort","a","b","matchedPersons","matcher","womanId","manId","indexOf","console","log","loveMatchings","woman","man","pastLoveMatchings","length","createLoveMatching","connect","personId"],"mappings":"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","sourcesContent":["/**\r\n * 每周四晚上12点执行。\r\n *思路：\r\n * 1、首先从数据库挑选出第一个城市里的所有用户\r\n * 2、对该城市的所有用户按照会员级别进行排序，得到一个用户列表\r\n * 3、从第一个用户开始计算匹配，匹配到计入数据库，并从列表中删除。\r\n * 4、该城市用户列表长度为0时停止\r\n * 5、将第一个用户所在城市从数据库中删除。挑选第二个用户所在城市，按照第一个城市算法计算。\r\n * 6、数据库长度为0时停止计算。\r\n * */\r\n\r\nimport { prisma } from '../generated/prisma-client'\r\nimport { DateStartTime } from '../services/settings'\r\nimport { birthdayToAge } from '../services/utils'\r\n\r\nconst now = new Date()\r\nconst phase = parseInt(`${(now.getTime() - DateStartTime.getTime()) / 1000 / 60 / 60 / 24 / 7}`, 10) + 1\r\nconst match = async () => {\r\n    const cities = await prisma.cities()\r\n    for (const lovecity of cities) {\r\n        // 1、找到该城市所有当期报名的人。\r\n        const cityLoveSignUps = await prisma.loveSignUps({\r\n            where: {\r\n                AND: [\r\n                    { city: { code: lovecity.code } },\r\n                    { period: `${phase}` }\r\n                ]\r\n            }\r\n        })\r\n        // 2、对该城市的所有用户按照会员级别进行排序，得到一个用户列表\r\n        const signUpPersons = []\r\n        for (const citLoveSignUp of cityLoveSignUps) {\r\n            const person = await prisma.loveSignUp({ id: citLoveSignUp.id }).person()\r\n            const loveSetting = await prisma.loveSignUp({ id: citLoveSignUp.id }).person().loveSetting()\r\n            // 计算会员等级\r\n            let grade = loveSetting.memeberGrade\r\n            // 如果会员等级为null，则grade为0\r\n            if (!loveSetting.memeberGrade) {\r\n                grade = 0\r\n            }\r\n            // 如果会员过期了，则grade为0\r\n            if (loveSetting.memeberGradeEndTime) {\r\n                if (new Date(loveSetting.memeberGradeEndTime) < new Date()) {\r\n                    await prisma.updateLoveSetting({\r\n                        where: { id: loveSetting.id },\r\n                        data: {\r\n                            memeberGrade: 0,\r\n                            memeberGradeEndTime: null,\r\n                        }\r\n                    })\r\n                    grade = 0\r\n                }\r\n            }\r\n\r\n            const newPerson = {\r\n                id: person.id,\r\n                gender: person.gender,\r\n                age: birthdayToAge(person.birthday),\r\n                myHeight: loveSetting.myHeight,\r\n                myWeight: loveSetting.myWeight,\r\n                otherAgeMin: loveSetting.otherAgeMin,\r\n                otherAgeMax: loveSetting.otherAgeMax,\r\n                otherHeightMin: loveSetting.otherHeightMin,\r\n                otherHeightMax: loveSetting.otherHeightMax,\r\n                otherWeightMin: loveSetting.otherWeightMin,\r\n                otherWeightMax: loveSetting.otherWeightMax,\r\n                memeberGrade: grade\r\n            }\r\n            signUpPersons.push(newPerson)\r\n        }\r\n        // 报名者按照等级从高到低排序\r\n        const sortedSignUpPersons = signUpPersons.sort((a, b) => b.memeberGrade - a.memeberGrade)\r\n        // 3、从第一个用户开始计算匹配，匹配到计入数据库。\r\n        const matchedPersons = []\r\n        for (const person of sortedSignUpPersons) {\r\n            for (const matcher of sortedSignUpPersons) {\r\n                let womanId\r\n                let manId\r\n                if (person.gender === \"male\") {\r\n                    manId = person.id\r\n                    womanId = matcher.id\r\n                } else {\r\n                    manId = matcher.id\r\n                    womanId = person.id\r\n                }\r\n                // 如果匹配成功\r\n                if (\r\n                    !~matchedPersons.indexOf(person.id) &&\r\n                    !~matchedPersons.indexOf(matcher.id) &&\r\n                    person.gender !== matcher.gender &&\r\n                    person.age >= matcher.otherAgeMin &&\r\n                    person.age <= matcher.otherAgeMax &&\r\n                    person.myHeight <= matcher.otherHeightMax &&\r\n                    person.myHeight >= matcher.otherHeightMin &&\r\n                    person.myWeight <= matcher.otherWeightMax &&\r\n                    person.myWeight >= matcher.otherWeightMin &&\r\n                    matcher.age >= person.otherAgeMin &&\r\n                    matcher.age <= person.otherAgeMax &&\r\n                    matcher.myHeight >= person.otherHeightMin &&\r\n                    matcher.myHeight <= person.otherHeightMax &&\r\n                    matcher.myWeight >= person.otherWeightMin &&\r\n                    matcher.myWeight <= person.otherWeightMax\r\n                ) {\r\n                    console.log('匹配成功 ')\r\n                    // 检查以前是否匹配成功过，匹配成功过的不再重复匹配\r\n                    const pastLoveMatchings = await prisma.loveMatchings({\r\n                        where:{\r\n                            AND:[\r\n                                {woman: {  id: womanId } },\r\n                                {man:  { id: manId } }\r\n                            ]\r\n                        }\r\n                    })\r\n                    console.log('pastLoveMatchings',pastLoveMatchings)\r\n                    if(pastLoveMatchings.length===0){\r\n                        console.log('创建匹配')\r\n                        matchedPersons.push(person.id)\r\n                        matchedPersons.push(matcher.id)\r\n                        await prisma.createLoveMatching({\r\n                            period: `${phase}`,\r\n                            city: { connect: { code: lovecity.code } },\r\n                            woman: { connect: { id: womanId } },\r\n                            man: { connect: { id: manId } }\r\n                        })\r\n                        break\r\n                    }\r\n                }\r\n            }\r\n            console.log('没有匹配成功')\r\n            // 没有匹配成功,对象为null\r\n            const personId = person.id\r\n            if (!~matchedPersons.indexOf(person.id)) {\r\n                matchedPersons.push(personId)\r\n                if (person.gender === \"male\") {\r\n                    await prisma.createLoveMatching({\r\n                        period: `${phase}`,\r\n                        city: { connect: { code: lovecity.code } },\r\n                        man: { connect: { id: personId } }\r\n                    })\r\n                } else {\r\n                    await prisma.createLoveMatching({\r\n                        period: `${phase}`,\r\n                        city: { connect: { code: lovecity.code } },\r\n                        woman: { connect: { id: personId } },\r\n                    })\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n\r\nconsole.log('match start...')\r\nmatch()\r\nconsole.log('match over!')\r\n\r\n"],"file":"match.js"}